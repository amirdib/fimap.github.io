var map = L.map('map').setView([48.856578, 2.351828], 13);
var tiles = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
       }).addTo(map);

var w = 600,
    h = 600,
    centered;

echelle = w * 250

m = d3.map(data, function(d, i) {
    if (d != undefined) return d[1];
});



var svg = d3.select(map.getPanes().overlayPane).append("svg"),
    g = svg.append("g").attr("class", "leaflet-zoom-hide");

// g  = svg.append("g")



d3.json("data/circo75.json", function(geoJSON) {
    

    var transform = d3.geoTransform({point: projectPoint}),
	path = d3.geoPath().projection(transform);
    
    var feature = g.selectAll("path")
	.data(geoJSON.features)
	.enter().append("path");


    map.on("viewreset", reset);
    
    reset();
    

    

    function reset(){
	var bounds = path.bounds(geoJSON),
	topLeft = bounds[0],
	    bottomRight = bounds[1];
	console.log(bounds);
	
	console.log('reset')
	svg.attr("width", bottomRight[0] - topLeft[0])
	    .attr("height", bottomRight[1] - topLeft[1])
	    .style("left", topLeft[0] + "px")
	    .style("top", topLeft[1] + "px");

	g.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");
	
	feature.attr("d", path)
	    .attr("id", "circonscriptions")
	    .attr("class", "circo");
    }
    
    
    function projectPoint(x, y) {
	var point = map.latLngToLayerPoint(new L.LatLng(y, x));
	this.stream.point(point.x, point.y);
    }
    
});




function clicked(d) {
    
    var x, y, k;
    
    if (d && centered !== d) {
	var centroid = path.centroid(d);
	x = centroid[0];
	y = centroid[1];
	k = 4;
	centered = d;
    } else {
	x = w / 2;
	y = h / 2;
	k = 1;
	centered = null;
    }

    
    g.selectAll("path")
	.classed("active", centered && function(d) { return d === centered; })
	.style("opacity","1");
    //debugger;
    g.transition()
	.duration(750)
	.attr("transform", "translate(" + w / 2 + "," + h / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
	.style("stroke-width", 1.5 / k + "px")
	.selectAll("path.active")
	.style("opacity","0.2");
}




